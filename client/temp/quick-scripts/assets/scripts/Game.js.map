{"version":3,"sources":["Game.js"],"names":["Common","require","JoystickBG","cc","Class","extends","Component","properties","dot","default","type","Node","displayName","ring","stickX","stickY","touchType","TouchType","DEFAULT","directionType","DirectionType","ALL","sprite","_stickPos","_touchLocation","shotStick","onLoad","_createStickSprite","FOLLOW","_initTouchEvent","node","setPosition","self","on","EventType","TOUCH_START","_touchStartEvent","TOUCH_MOVE","_touchMoveEvent","TOUCH_END","_touchEndEvent","TOUCH_CANCEL","event","getLocation","touchPos","convertToNodeSpaceAR","x","y","distance","_getDistance","p","radius","width","posX","posY","Math","cos","_getRadian","sin","_getAngle","_setSpeed","getPosition","_speed"],"mappings":"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","file":"Game.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["var Common = require('JoystickCommon');\r\nvar JoystickBG = require('JoystickBG');\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        dot: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: '移动摇杆节点',\r\n        },\r\n        ring: {\r\n            default: null,\r\n            type: JoystickBG,\r\n            displayName: '移动摇杆背景节点',\r\n        },\r\n        stickX: {\r\n            default: 0,\r\n            displayName: '摇杆X位置',\r\n        },\r\n\r\n        stickY: {\r\n            default: 0,\r\n            displayName: '摇杆Y位置',\r\n        },\r\n        touchType: {\r\n            default: Common.TouchType.DEFAULT,\r\n            type: Common.TouchType,\r\n            displayName: '触摸类型',\r\n        },   \r\n        directionType: {\r\n            default: Common.DirectionType.ALL,\r\n            type: Common.DirectionType,\r\n            displayName: '方向类型',\r\n\r\n        },   \r\n        sprite: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: '操控的目标',\r\n\r\n        },   \r\n    \r\n        _stickPos: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: '摇杆当前位置',\r\n        },   \r\n\r\n        _touchLocation: {\r\n            default: null,\r\n            type: cc.Node,\r\n            displayName: '摇杆当前位置',\r\n        },\r\n\r\n\r\n        shotStick:{\r\n            default:null,\r\n            type: cc.Node,\r\n            displayName: \"射击摇杆节点\"\r\n        }\r\n    },\r\n\r\n    onLoad: function () {\r\n        this._createStickSprite();\r\n        //当触摸类型为FOLLOW会在此对圆圈的触摸监听\r\n        if(this.touchType == Common.TouchType.FOLLOW){\r\n            this._initTouchEvent();\r\n        }\r\n    },\r\n\r\n    _createStickSprite: function()\r\n    {\r\n        //调整摇杆的位置\r\n        this.ring.node.setPosition(this.stickX, this.stickY);\r\n        this.dot.setPosition(this.stickX, this.stickY);\r\n    },\r\n\r\n    _initTouchEvent: function()\r\n    {\r\n        var self = this;\r\n\r\n        self.node.on(cc.Node.EventType.TOUCH_START, self._touchStartEvent, self);\r\n\r\n        self.node.on(cc.Node.EventType.TOUCH_MOVE, self._touchMoveEvent, self);\r\n\r\n        // 触摸在圆圈内离开或在圆圈外离开后，摇杆归位，player速度为0\r\n        self.node.on(cc.Node.EventType.TOUCH_END, self._touchEndEvent,self);\r\n        self.node.on(cc.Node.EventType.TOUCH_CANCEL, self._touchEndEvent,self);\r\n\r\n        \r\n    },\r\n\r\n    _touchStartEvent: function(event) {\r\n        // 记录触摸的世界坐标，给touch move使用\r\n        this._touchLocation = event.getLocation();\r\n        var touchPos = this.node.convertToNodeSpaceAR(event.getLocation());\r\n        // 更改摇杆的位置\r\n        this.ring.node.setPosition(touchPos);\r\n        this.dot.setPosition(touchPos);\r\n        // 记录摇杆位置，给touch move使用\r\n        this._stickPos = touchPos;\r\n    },\r\n\r\n    _touchMoveEvent: function(event) {\r\n\r\n        // 如果touch start位置和touch move相同，禁止移动\r\n        if (this._touchLocation.x == event.getLocation().x && this._touchLocation.y == event.getLocation().y){\r\n            return false;\r\n        }\r\n        // 以圆圈为锚点获取触摸坐标\r\n        var touchPos = this.ring.node.convertToNodeSpaceAR(event.getLocation());\r\n        var distance = this.ring._getDistance(touchPos,cc.p(0,0));\r\n        var radius = this.ring.node.width / 2;\r\n\r\n        // 由于摇杆的postion是以父节点为锚点，所以定位要加上touch start时的位置\r\n        var posX = this._stickPos.x + touchPos.x;\r\n        var posY = this._stickPos.y + touchPos.y;\r\n        if(radius > distance)\r\n        {\r\n            this.dot.setPosition(cc.p(posX, posY));\r\n        }\r\n        else\r\n        {\r\n            //控杆永远保持在圈内，并在圈内跟随触摸更新角度\r\n            var x = this._stickPos.x + Math.cos(this.ring._getRadian(cc.p(posX,posY))) * radius;\r\n            var y = this._stickPos.y + Math.sin(this.ring._getRadian(cc.p(posX,posY))) * radius;\r\n            this.dot.setPosition(cc.p(x, y));\r\n        }\r\n        //更新角度\r\n        this.ring._getAngle(cc.p(posX,posY));\r\n        //设置实际速度\r\n        this.ring._setSpeed(cc.p(posX,posY));\r\n    },\r\n\r\n    _touchEndEvent: function(){\r\n        this.dot.setPosition(this.ring.node.getPosition());\r\n        this.ring._speed = 0;\r\n    },\r\n\r\n});\r\n"]}